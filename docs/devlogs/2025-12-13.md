### Summary

I fixed duplicate subtitles, which were coming from two code paths playing the same sounds. I also fixed the position of explosions - the explosion area was being spawned correctly, but its global position was being set before it was added to the scene tree, so it was resetting.

I figured out how to assign surface types in Trenchbroom/func_godot. The best solution is to make it automatic with an option to override. The system registers a list of keywords and uses func_godot hooks to scan geometry at load time, comparing texture names against keywords.

I implemented ammo pickups and usage. Firing ranged weapons now consumes ammo, reloading refills the weapon from your inventory, and picking up ammo in the world adds to your inventory. The current, max, and spare amount of ammo is shown in the HUD.

I started implementing melee weapon durability with a condition component. Each surface type has different durability damage - 0 for carpet, snow, and water; 5 for wood and zombies; 10 for metal; 20 for brick and stone.

### Progress

- fixed duplicate subtitles
	- this was coming from two different code paths:
		- the player `_add_sound` method was playing sounds that already had play-on-ready set
		- the weapon pickup method was spawning the same weapon-use sound as the weapon switch method, but using weapons automatically switches to them, which caused the sound to play twice
- fixed the position of explosions
	- the explosion area was being spawned correctly, but its global position was being set before it was added to the scene tree, so it was being reset/moving after being added
	- add the explosion to the scene tree before updating its position/rotation/transform
- figured out how to assign surface types in Trenchbroom/func_godot
    - the best solution is to make it automatic, with an option to override them
    - register a list of keywords and use the func_godot hooks to scan geometry at load time
    - print a warning for any entities with multiple materials
    - compare texture name against keywords, using material metadata and entity properties as overrides
    - set in collision shape meta
    - make sure it ends up on the shape node rather than meshe node
	    - for illusionary nodes that don't have collision like water, it ends up on the Node3D parent of the MeshInstance3D
	    - this is not a big deal right now, because you can't collide with those nodes anyway, so their surface type will never be used
- implemented ammo pickups and usage
	- firing ranged weapons now consumes ammo
	- reloading refills the weapon ammo from your inventory ammo
	- picking up ammo items in the world refills your inventory ammo
	- the current, max, and spare amount of ammo is shown in the HUD
	- melee weapons will need their own condition/durability component
- started implementing melee weapon durability
	- melee weapons can have a durability component
	- has current and max condition
	- durability damage for each surface type
		- 0 for carpet, snow, and water
		- 5 for wood and zombies
		- 10 for metal
		- 20 for brick and stone
- looked at refactoring nav but did not start that today
	- will need to link the character entity or a component on it to the nav agent
		- movement component has the target position and could update the nav agent with that
		- but velocity component needs to be updated with the safe velocity calculated by the nav agent
		- agent velocity should replace any other velocity calculated by the movement system
	- movement component should probably split up the target position and next nav point/position
- only remove ammo pickups if they are empty
	- if player cannot pick up all of the ammo, leave the item but reduce the ammo in it

### TODOs

- handle pausing correctly w.r.t the footstep timers
	- currently, all pending footsteps play when the game resumes, because the ticks msec continues to increase but the footstep system doesn't run while paused
- [x] set surface type in func godot
	- the `_func_godot_apply_properties` hook should be a good point to scan geometry nodes for materials and set up surface type metadata
- add debug-only objects, like the explosion marker
- [x] make sure the dialogue tween commands still work
	- [x] probably time to set up helpers for them
		- helpers have subclass/closure for entity and markers
- ammo system
    - [x] start simple, dictionary of type and quantity
    - [x] each weapon will have some loaded and a max loaded count
    - [x] pickups, weapons, and pockets can all store many types of ammo
    - [x] picking up an ammo component adds it to your inventory, which can also unload weapons on pickup (should probably be an option)
    - [x] reloading removes from pocket, adds to weapon
    - can you unload weapons to use the ammo in a different one?
    - levels could have a starting ammo component set on players when they load in
	    - set/replace
	    - add might allow for farming
	    - max of would help players who were low
	    - min would punish players with too much/make hard areas where your ammo is lost
    - infinite/timed ammo stations would have an add function
- new sounds
    - melee weapon break noises
    - [x] gun reload noises
    - gun empty noises
    - door sounds
- melee durability
    - [x] add a separate condition component for melee weapons and other items
    - [x] ammo label shows current condition
    - reload becomes repair for melee
    - repair parts allow repairing melee weapons
    - [x] durability usage based on surface type
    - [x] update ammo label after each swing
- [x] enemy weapon switching
    - zombies switch weapons when durability runs out, eventually switching to natural attack with infinite ammo
    - zombie weapon priority can be least durability (keep using broken), least > zero (switch more often, use infinite last), or highest first (use infinite first)
- [x] only play zombie footsteps when they are alive
- add double-barrel shotgun
- [x] add bullet impact for grass and asphalt/concrete
- multiple weapon swing paths based on character velocity
- multiple muzzle markers
    - Alternating for gatling gun or double shotgun
    - simultaneous for double shotgun alt
- [x] cache weapon effects by type for faster replay

### Next Up

- [x] add shotgun empty sound
- [x] add door open and close sound
- make a debug ammo station (infinite ammo box)
- make a death match enemy spawner
- explosion decals
- split ignite-on-hit for projectiles and melee
	- consider adding projectiles that do not ignite anything
	- and ones that ignite everything they possibly can
- test fading between skin materials
- add effects to the spawn action

### Melee Impact Sounds

Melee weapons don't have impact sounds yet, but there is a weapon effect type for melee impact that can be used. The sounds need to be linked to the hit area and surface type, so when the hit area comes into contact with a collision shape, fetch the surface type and play the right effect.

For ranged weapons, most of this is handled by the projectile system. Melee weapons don't have a system like that, and I'm not sure if that would make sense, considering they use a damage area.

### Recording a Demo

I need to record a demo video to promote the game on Itch and social media. This is a script for the demo recording.

#### Demo Script

It would be cool to actually script the demo, but that might take more time than it's worth right now.

Make sure to record the audio and video.

- pick up the baseball bat
- pick up the key
- pick up the medkit
- pick up the shotgun
- switch to the bat
- open the inventory menu
- talk to the hotel clerk
- pick up the armor
- stand in the fire area
- stand in the acid area
- open the room 4 door
- shoot the flashlight zombie
- go back to room 1
- open the objectives menu
- unlock the room 2 door
- shoot on of the barrels in room 2
- hide behind the door
	- keep the ball props in sight
- after explosion, find zombie
	- hopefully it is on fire
- shoot zombie
- shoot ball prop
- move to portal
- use portal
