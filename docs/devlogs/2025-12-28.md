### Summary

Put my desk back together after moving it back into my office.

I implemented the save/load feature today. While moving my desk, I had time to think through the save file structure. The serialization code in GECS is good, but it doesn't handle relationships and doesn't keep track of deleted entities. I wanted something that would split up the level data and the player data, matching the scene structure.

Once the resources had been written, the save game code came together easily. The most interesting part was loading the component class names and paths from Godot's class DB. I added prefab path variable to entities, support for deleted entities with a delete list for each level, and stored the current level key and last spawn point.

I improved performance by disabling hidden menus - when menus are hidden, set their processing mode to disabled. Godot has trouble with processing time when there are many control nodes, even if they are hidden.

I fixed the vignette flash when the game starts, which was caused by a problem with the lerp direction when fading effects in and out. I also limited the minimum softness of the vignette to 0.1 to prevent hard edges.

I fixed the first bullet not breaking glass issue. Previously, the first bullet fired would pass through props until it reached level geometry. This was caused by the physics system not detecting collisions between thin objects and fast-moving bullets. Enabling continuous collision detection on bullet bodies fixed it.

I need to load entity class names in the same way, in addition to making sure that entities already exist as a node, or can be reloaded as a node of the correct type. This might take some metadata that indicates the source/ prefab scene when the entity is first created.

In theory, entities that are part of the level will always exist (unless they were removed or had their id changed) and no nodes need to be created. Entities that were created by the spawn action will need to be marked with their scene, as will entities that the player has picked up and carried.

- [x] add prefab path variable to ze-base entity
- [x] save prefab path with entities
- [x] validate prefab path is not empty when entity is created
- [x] when save has an entity that is not in the world, load it from the prefab path
- [x] for entities without preset ids, assign them using the same algorithm but with a runtime prefix or suffix

The save game also needs to know the current level and load and/or reload it.

- [x] store the current level key in the save
- [x] call world load during game load, before adding entities
- [x] store the last spawn point or checkpoint
- [x] update when level or spawn point change

Add support for deleted entities:

- [x] delete list for each level
- [x] delete during load
- [x] track when deleted
- [x] exclude bullets (or only include persistent?)

Switch to JSON:

- [x] install the addon
- [x] register the classes (persistence resources only)
- [x] add to save manager
- [ ] fix errors with NodePaths and some other classes

Saving to JSON can really be part of v2, as long as saving and loading are working in general.

### Fixing the Loading Vignette

After you start the game or load from a save, the first frame or two has a very strong stamina vignette effect, no matter what your stamina really is. This is caused by the effect fading out at the beginning with a softness setting of 0.0, making it a hard circle that fades out right after the game loads.

I wanted to fix this because it is very noticeable and seemed like a good thing to polish, since it happens every time you load. I was able to set breakpoints for the first time the vignette effect's strength is adjusted, which showed the effect well:

![[Pasted image 20251228204034.png]]

Inspecting the shader settings, I could see that softness was at 0.0:

![[Pasted image 20251228204127.png]]

Limiting the vignette's softness parameter into the range (0.1, 1.0) helped reduce the flash, but there was another problem in the effect strength `lerp` line, which had the parameters backwards. Fixing both of those removed the initial flash of strong vignette, although the stamina system still takes a moment to catch up and update the effect based on the player stamina. Adding an on-level-loaded hook to the stamina system and updating the effects for each player on load seems to have fixed that part as well.

### First Bullet Not Breaking Glass

The first bullet you fire after starting the game will never break the glass windows. It seems like there is a problem with the physics system, because the collider for that first bullet is the wall, not the glass:

`Bullet is colliding with: <null>, entity_1_brush_0_collision_shape:<CollisionShape3D#268854891853>`

![[Pasted image 20251228210302.png]]

It seems like the bullet or the raycast on it need better physics monitoring in order to detect the entity collision.

Enabling `Continuous CD` for the bullet's body seems to have resolved this one.

### Progress

- worked on the save/load feature:
	- added new saved game resources
	- implemented most of the save and load logic
	- focus on the save game name input when the new save dialog opens
- improved performance by disabling hidden menus
	- when menus are hidden, set their processing mode to disabled
	- Godot has trouble with processing time when there are many control nodes, even if they are hidden
- ignore the menu shortcuts (escape/pause, objectives, inventory, etc) during the loading menu
	- previously, players could press escape to close the loading menu or use another shortcut to switch menus while the level was loading
	- once the level loaded, the other menu would close and the player would be moved to the spawn point
	- this prevents players from switching menus, keeping the loading screen up until after the player has been moved
- fixed the vignette flash when the game starts
	- this was caused by a problem with the `lerp` direction when fading effects in and out
	- also limited the minimum softness of the vignette to 0.1 to prevent hard edges
- fixed the first bullet not breaking glass issue
	- previously, the first bullet fired by a player would not hit the intended target and pass through props until it reached level geometry or some large entity models
	- this was most visible with the glass sheets in the debug level, bullets would often pass through them and hit the blue balls or the brick wall behind the glass
	- this was caused by the physics system not detecting the collision between the thin object and the fast-moving bullet
	- enabled continuous collision detection on bullet bodies, which stops them accurately enough for the raycast to detect the collision

With those last two issues fixed, that reduces the list of major problems to the duplicate/stuck screen effects issue. Resolving that will make it possible to record or share a working demo. Some additional content is still needed for the demo release on Itch.

### TODOs

- [x] start implementing save classes
- [x] find a way to disable hidden menus
- [x] ignore escape key during loading screen
- screen effect curves are not being saved
- [x] focus on save game name when the dialog opens

### Next Up

- add throwing flares
	- flare lights when thrown (projectile is flare model + particles and light)
	- flare ignites everything it touches
- add the zombie acid throwing weapon
	- make an acid blob
	- decal effect
- find assets for stick and rock weapons
- find more street corner assets for the bus stop and test town levels
	- signs, lights, trash, etc
	- add a fence to the yard that you can't reach
- copy devlogs into github
	- make sure they are generally coherent
	- add a summary to them if needed
- [x] figure out whether to use one Itch page or two
	- one for the framework as an asset, one for the game?
		- one for the game, link to the github
- [x] start building the fishing pier level
	- pier and small river or ocean-side area
	- a few buildings, a concrete barrier with wooden pier
	- should probably have a muddy path down to the water
- scale up test town level
	- roads should be at least 6x4 blocks wide, 3x4 per lane
	- buildings need to be much larger
	- use cars as a reference size
- [x] set custom skies for the spooky church level
	- spooky sky
- passive zombie behavior
	- regular behavior with attack and chase modified to only react when the zombie takes damage
- update the readme
	- recent features
	- link to the full features list
	- feature highlights: health and stamina systems, save and load from GECS including relationships and deleted entities, mod support with custom levels, physics-based weapons with accurate hitboxes, node-based trigger and action system for adding new interactions with little or no code, FSM for zombie behavior (integrated with ECS, persistent blackboard), survivor dialogue with dialogue trees
	- for an RPG, need to add: mana system, spell inventory, magical effects, crafting
