### Summary

I continued integrating zombie AI states with ECS. I made the behavior blackboard a component and added a behavior system that is responsible for ticking the state machine. This allows zombies to save their behavior state with the game data.

I figured out how to split up and remove the ZB_Zombie event handler by using action nodes within each of the detection areas. The vision cone required special handling, but it works now.

I fixed errors when an exploding barrel killed a zombie - the relationships were not being added correctly. I also fixed hitting the environment doing damage to the baseball bat again, and increased time between the hotel clerk's idle lines.

I improved logging for when skins change and when the weather changes.

I did a lot of work breaking down the zombie event handler and documenting the issues with separating behavior trees from detection areas. The main challenge is that the state machine cannot be the scene root because it's not 3D, and the areas and states need to be linked somehow. Using editable children allows linking at two points: the behavior root and the FSM.

### Progress

- [x] continue integrating zombie AI states with ECS
	- [x] make the behavior blackboard a component
	- [x] a behavior system should be responsible for ticking the state machine
	- ~~the state machine should usually be the root of the behavior tree scene~~
	- [x] components:  attention, behavior with blackboard~~, and blackboard~~
	- [x] systems:  attention feeds into targeting, behavior acts on that data
	- [x] allows zombies to save their behavior state with the game data
	- [ ] adjust the signature to entity-component-delta or a proper context class
- [x] figure out how to split up/remove the ZB_Zombie event handler
	- [x] using action nodes within each of the detection areas?
		- [x] works today in everything but the vision cone
		- [x] can't track detected bodies
			- already tracked in trigger area with empty event
		- [x] can't set actor position to a blackboard values
- [x] improve some logging
	- [x] when skins change
	- [x] when the weather changes
- [x] fix errors when an exploding barrel killed a zombie
	- [x] relationships were not being added correctly
- [x] increase time between the hotel clerk's idle lines
- [x] fix so that hitting the environment will do damage to the baseball bat again

### TODOs

- [x] fix set-state action needing entity
- [x] add entity back to state machine
- ~~remove on-ready in zombie events~~
- [x] run zombie events on-ready when entity changes
- [x] rename parent area 3d trigger to area 3d trigger proxy
- [x] make a trigger vision cone?
- [x] loading level hints should have a translucent background

### Next Up

- finish implementing important effects
    - like in css, they override anything else
- [x] add rain effects to the player
    - floating effects centered on the player
    - use a raycast to detect overhangs
    - sync with weather groups
- figure out the no-clip mode
    - gravity is still applying to players and they sink into the abyss
- add a way to load single mod levels outside of a campaign
    - If level is not a key, check if it is a full path/file exists
- sync weather groups when the level loads
- add a passive zombie behavior tree
    - mostly identical to aggressive, but they don't respond to vision or sound
- screen effects: important vs add/replace?
    - these could have an important flag like css,and last important would win
    - or add/replace and the last replace would usually win, but later adds could add to it
    - the latter is interesting but too complex
    - min and max would be more useful: no more than or no less than
- hitscan/laser weapons
    - projectile has no physics
    - raycast, then send particles or scale a mesh with repeating texture
    - sprite3d base star
    - use billboards heavily
- [x] flare weapon
    - ignites when thrown/projectile is burning
    - short throw arc, bounce, burn anything it touches
    - leave a small flame effect and decal on the world geometry
    - options menu set aim distance
    - can be adaptive/ automatic
- [x] find ways to reduce processing time
    - disable processing for hidden menus

### Random Thought

Just a quick note about the structure of action events.

- action events have a cause and actor
- tick events have a delta and ticker

### Breaking down the ZB_Zombie event handler

The zombie event handler script has gotten too large and needs to be broken up into smaller pieces that can be reused.

- all of the outgoing entity links from the behavior subtree indicate a lack of context
	- the entity who is behaving should be passed through
- when it comes to behavior packs, there are two choices:
    - Keep the detection areas in the parent, and expose the states somehow for them to activate
    - move the areas into the behavior scene, which prevents changing their parameters and size, but keeps the system contained


Both methods have problems:

- the behavior blackboard action needs a reference to the entity
	- which can be the trigger area's parent entity
		- if that is part of the same scene
- an action-area proxy can interface with third-party areas

In addition:

- the Area3D nodes cannot be placed under the state machine, which is not a spatial node
- the states and transitions do need to be placed under the state machine
- the parent entity feature of trigger areas cannot be used because there is no entity in the scene

So then:

- behavior state action only needs the entity because state_machine.set_state needs it in the signature

But still:

- the set-state-machine-state nodes can no longer access the state machine
	- the state machine cannot be the scene root because it's not 3D
- it seems like it would make more sense to separate the areas and the behavior tree/state machine
	- but then they cannot be linked as nodes
- everything that selects a specific state depends on the internal structure of the state machine
- asking the state machine to transition does not need any insight
- some of the actions need a reference to an area
	- editable children allows you to make links to the outer parent

Remaining issues:

- [x] vision cone area is throwing errors and accumulating references in the probe map
    - caused by the vision cone having a shape that had been added in the editor
- [x] behavior tree has to be added with editable children enabled
    - in order to:
	    - link the area actions to their areas in the parent
	    - link the state actions to their states in the child
	- [x] both of these would be fixed by moving the areas into the behavior scene
		- [x] but that would break the vision helper and require the entity proxy again
- [x] zombie physics lock node is a weird pattern
	- ~~could become an action,  but it needs to run on ready and death~~
	- [x] could be renamed to entity physics lock helper
- [x] zombie vision node should be turned into a generic vision-to-perception node
	- [x] need to get rid of the `on_ready` method first
	- [x] perception component cache
- [x] the behavior component can no longer access the state machine
	- [x] using editable children allows linking the zombie scene to the behavior scene at two points: the behavior root (the entity to the entity proxy) and the FSM (for the behavior component/system)
